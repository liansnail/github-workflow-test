name: Deploy Agent

on:
  workflow_dispatch:
    inputs:
      agent:
        description: 'Agent to deploy'
        required: true
        type: choice
        options:
          - agent-ar
          - agent-rs
          - agent-ts
          - agent-bt
      run-name:
        description: 'Custom run name'
        required: false
        type: string

run-name: ${{ inputs.run-name || format('Deploy {0}', inputs.agent) }}

jobs:
  validate-agent:
    name: "ğŸ” Validate ${{ inputs.agent }}"
    runs-on: ubuntu-latest
    outputs:
      agent-type: ${{ steps.detect.outputs.agent-type }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect agent type and validate
        id: detect
        run: |
          AGENT="${{ inputs.agent }}"

          if [ ! -d "apps/$AGENT" ]; then
            echo "âŒ Agent directory apps/$AGENT does not exist"
            exit 1
          fi

          # Determine agent type based on naming
          case "$AGENT" in
            *-ar) AGENT_TYPE="augmented-reality" ;;
            *-rs) AGENT_TYPE="rust-service" ;;
            *-ts) AGENT_TYPE="typescript-service" ;;
            *-bt) AGENT_TYPE="behavior-tree" ;;
            *) AGENT_TYPE="unknown" ;;
          esac

          echo "âœ… Agent $AGENT validated (type: $AGENT_TYPE)"
          echo "agent-type=$AGENT_TYPE" >> $GITHUB_OUTPUT

  pre-deploy:
    name: "ğŸ”§ Pre-deploy ${{ inputs.agent }}"
    needs: validate-agent
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup environment
        run: |
          echo "ğŸ”§ Setting up environment for ${{ inputs.agent }}"
          echo "Agent type: ${{ needs.validate-agent.outputs.agent-type }}"

          # Simulate environment setup based on agent type
          case "${{ needs.validate-agent.outputs.agent-type }}" in
            "rust-service")
              echo "ğŸ“¦ Setting up Rust toolchain..."
              sleep 2
              ;;
            "typescript-service")
              echo "ğŸ“¦ Setting up Node.js environment..."
              sleep 2
              ;;
            "augmented-reality")
              echo "ğŸ“¦ Setting up AR development environment..."
              sleep 3
              ;;
            "behavior-tree")
              echo "ğŸ“¦ Setting up behavior tree runtime..."
              sleep 2
              ;;
          esac

          echo "âœ… Environment setup complete"

  build:
    name: "ğŸ—ï¸ Build ${{ inputs.agent }}"
    needs: [validate-agent, pre-deploy]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build agent
        run: |
          echo "ğŸ—ï¸ Building ${{ inputs.agent }}..."
          cd "apps/${{ inputs.agent }}"

          # Simulate build process
          case "${{ needs.validate-agent.outputs.agent-type }}" in
            "rust-service")
              echo "ğŸ¦€ Running cargo build..."
              sleep 5
              ;;
            "typescript-service")
              echo "ğŸ“œ Running npm build..."
              sleep 4
              ;;
            "augmented-reality")
              echo "ğŸ¥½ Building AR components..."
              sleep 6
              ;;
            "behavior-tree")
              echo "ğŸŒ³ Compiling behavior tree..."
              sleep 3
              ;;
          esac

          echo "âœ… Build completed successfully"

      - name: Run tests
        run: |
          echo "ğŸ§ª Running tests for ${{ inputs.agent }}..."
          sleep 3
          echo "âœ… All tests passed"

  deploy:
    name: "ğŸš€ Deploy ${{ inputs.agent }}"
    needs: [validate-agent, build]
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Deploy to staging
        run: |
          echo "ğŸš€ Deploying ${{ inputs.agent }} to staging..."
          echo "Agent type: ${{ needs.validate-agent.outputs.agent-type }}"
          sleep 4
          echo "âœ… Staging deployment complete"

      - name: Run smoke tests
        run: |
          echo "ğŸ’¨ Running smoke tests..."
          sleep 2
          echo "âœ… Smoke tests passed"

      - name: Deploy to production
        run: |
          echo "ğŸš€ Deploying ${{ inputs.agent }} to production..."
          sleep 5
          echo "âœ… Production deployment complete"

  post-deploy:
    name: "ğŸ“Š Post-deploy ${{ inputs.agent }}"
    needs: [validate-agent, deploy]
    runs-on: ubuntu-latest
    if: success()

    steps:
      - name: Health check
        run: |
          echo "ğŸ¥ Running health checks for ${{ inputs.agent }}..."
          sleep 3
          echo "âœ… Health checks passed"

      - name: Update monitoring
        run: |
          echo "ğŸ“Š Updating monitoring dashboards..."
          sleep 2
          echo "âœ… Monitoring updated"

      - name: Notify team
        run: |
          echo "ğŸ“¢ Notifying team of successful deployment:"
          echo "   Agent: ${{ inputs.agent }}"
          echo "   Type: ${{ needs.validate-agent.outputs.agent-type }}"
          echo "   Run: ${{ github.run_number }}"
          echo "âœ… Notification sent"